基于IFS 像素
坐标重建的像
素坐标
将MCI 图像和
IFS 图像换算到同
一个参考系下
7
参考星表准备
Gaia 星表
校正后的Gaia
星表天球坐标
对Gaia 星表的坐
标进行自行、视
差、光行差校正
8
WCS 解算
图像的像素坐
标，像素坐标
对应天球坐标
WCS 头文件参
数
通过拟合WCS
变换来解算出
WCS 参数
8.3.3.13 IFS 单次处理数据立方生成工作包
该工作包（编号：KSC-SJ6-PK-13）生成数据立方并进行可用
性标记。依据谱线的空间排列位置信息，将波长流量定标后的单次
曝光谱线文件，排列为数据立方。红蓝两端曝光生成的独立的红、
蓝数据立方。采用误差加权的方式将红、蓝两端的数据立方拼接为
全波段数据立方。对数据立方进行质量检查和索引后，作为IFS 的
1 级数据存入数据库。该工作包的结构示意图和功能模块列表分别
见图10.115 和表10.85。
波长流量定标
后的科学图像
数据立方生成
位置空间
排列信息
蓝端数据立方
红端数据立方
红蓝数据立方
拼接
全波段
数据立方
数据库
（一级数据）
可用性检查及
标记
1级单次曝光数
据立方
单次处理数据立方生成及可用性标记工作包
图10.115 IFS 单次处理数据立方生成工作包的结构示意图
表10.85 IFS 单次处理数据立方生成工作包的功能模块列表
序号
功能模块
名称
输入
输出
实现功能
1
数据立方生
成
波长流量都定
标后的科学图
像（红端或蓝
红端或蓝端的
数据立方
将光谱按空间位置排
列为数据立方
156
端）
、光谱位
置空间排布信
息
2
红蓝数据立
方拼接
同一目标源红
端和蓝端的数
据立方
拼接后的全波
段数据立方
将红、蓝数据立方在
分色片分光区域按信
噪比进行加权平均，
拼接为全波段的数据
立方
3
质量检查及
数据库索引
红、蓝、及全
波段数据立方
正常图像的数
据立方
数据质量检查及标
记，数据库索引
8.3.3.14 IFS 多次曝光数据可用性工作包
该工作包（编号：KSC-SJ6-PK-14）针对IFS 同一科学目标单
次曝光处理后存入数据库的一级数据，目的是读取保证单次曝光数
据中的质量标记，并同时作独立的可用性检查，最终获取可用于多
次曝光合成的可用数据集。在多次曝光数据可用性工作包中主要包
含数据读取和可用性检查模块。给定目标源IFS 单次曝光数据集进
入该模块后先读取数据，然后再进行可用性检查，最后输出可用数
据集。该工作包的结构示意图和功能模块列表分别见图10.116 和表
10.86。
数据库
I FS单次曝
光数据集
图像数据可用性
检查
可用图像数据
数据读取
图10.116 IFS 多次曝光数据可用性工作包的结构示意图
表10.86 IFS 多次曝光数据可用性工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
数据读取
IFS 单次曝光的
一级数据集
IFS 单次曝光的一
级灯谱数据和图
像数据集
区分数据类型
2
图像数据可用
性检查
IFS 单次曝光的
一级图像数据集
IFS 可用一级图像
数据集，可用性
标记
获取可用图像
数据集并生成
可用性标记
157
8.3.3.15 IFS 多次曝光合成几何框架工作包
该工作包（编号：KSC-SJ6-PK-15）针对可用一级图像数据集，
进行单次曝光图像的坐标变换和叠加图像的空间创建。主要包含两
个模块，单次曝光图像坐标变换和叠加图像空间创建。可用图像数
据集进入该工作包中，先经过单次曝光图像坐标变换模块将所有图
像从各自的图像坐标系转换到统一坐标系下；随后根据转换后的叠
加图像信息，在叠加图像空间创建模块中自动创建叠加图像存储空
间以及给出叠加图像的天体测量信息。该工作包的结构示意图和功
能模块列表分别见图10.117 和表10.87。
可用图像数据集
单次曝光图像坐
标变换
叠加图像空间创
建
坐标变换后图像
叠加图像天体测
量信息
图10.117 IFS 多次曝光合成几何框架工作包的结构示意图
表10.87 IFS 多次曝光合成几何框架工作包的功能模块列表
序号
功能模块名
称
输入
输出
实现功能
1
单次曝光图
像坐标变换
可用图像数据
坐标变换后图
像数据
将单次曝光图像转换
到统一坐标系下
2
叠加图像空
间创建
单次曝光图像
天体测量信息
叠加后图像天
体测量信息
创建叠加图像暂存空
间以及输出合成图像
天测信息
8.3.3.16 IFS 多次曝光图像叠加工作包
该工作包（编号：KSC-SJ6-PK-16）使用坐标变换后的图像，
在叠加图像暂存空间中填充数据，生成合成图像。主要有三个模块，
图像坐标锚定，数据可用性二次检查，数据叠加。首先锚定出叠加
图像指定像素的在坐标变换后图像中的一组匹配像素数据集。随后
对该数据集进行数据可用性检查，排除出离群值，最后用统计的方
法将这个数据集进行叠加，最后输出合成图像以及图像可用性信息。
该工作包的结构示意图和功能模块列表分别见图10.118 和表10.88。
158
坐标变换后图
像
图像坐标锚定
数据可用性二
次检查
数据叠加
叠加图像暂存
空间
合成图像
图10.118 IFS 多次曝光图像叠加工作包的结构示意图
表10.88 IFS 多次曝光图像叠加工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
图像坐标锚定
坐标变换后图
像数据，叠加
图像暂存空间
锚定数据集
锚定出叠加图像指定
像素的在坐标变换后
图像中的一组匹配像
素数据集
2
数据可用性二次
检查
锚定数据集
锚定可用数
据集
数据可用性检查，排
除出离群值
3
数据叠加
锚定可用数据
集
叠加数据和
数据可用性
用统计的方法将这个
数据集进行叠加
8.3.3.17 IFS 天光背景扣除工作包
该工作包（编号：KSC-SJ6-PK-17）主要功能为基于合成图像
以及天光背景模型，迭代扣除天光背景，最后输出扣除天光背景合
成图像的工作包。主要包含天光背景扣除模块和判断模块。结合天
光背景模型，在天光背景扣除模块中扣除天光，随后在判断模块中
判断天光背景是否扣除符合条件，若符合则输出，否则循环进行天
光背景扣除工作。该工作包的结构示意图和功能模块列表分别见图
10.119 和表10.89。
合成图像
天光背景扣除
是否扣除干净
天光背景模型
扣除天光背景后
合成图像
159
图10.119 IFS 天光背景扣除工作包的结构示意图
表10.89 IFS 天光背景扣除工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
天光背景扣除
合成图像，天
光背景模型
扣除天光背
景后图像
扣除天光
2
判断扣除干净
上一步扣除天
光背景后图像
判断结果
判断天光背景是否扣
除符合条件
8.3.3.18 IFS 多次曝光合成误差估算工作包
该工作包（编号：KSC-SJ6-PK-18）主要是从单次曝光误差中，
通过误差传递计算出合成图像的误差和协方差矩阵。主要包含误差
计算，协方差计算，协方差矩阵压缩三个模块。误差计算模块计算
各自的独立误差；协方差计算模块计算像素之间的协方差，并通过
协方差矩阵压缩模块进行压缩减小存储空间。最后输出误差和协方
差数据。该工作包的结构示意图和功能模块列表分别见图10.120 和
表10.90。
单次曝光图像误
差
误差计算
协方差计算
协方差矩阵压缩
误差和协方差数
据
图10.120 IFS 天光背景扣除工作包的结构示意图
表10.90 IFS 天光背景扣除工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
误差计算
单次曝光误差
合成图像误
差
计算各自的独立误差
2
协方差计算
单次曝光误差
协方差矩阵
计算像素之间的协方
差
3
协方差矩阵压缩
协方差矩阵
压缩矩阵
压缩协方差矩阵
160
8.3.3.19 IFS 多次曝光合成文件生成工作包
该工作包（编号：KSC-SJ6-PK-19）主要任务是收集以上图像
合成流程中的所有有用数据，并打包FITS 文件，生成DRP 数据输
入数据库中。主要分为头文件创建，图文件创建，FITS 文件输出这
三个模块。头文件创建模块收集天体测量信息，图像基本星系等有
用数据；图文件创建模块收集流量数据立方，可用性数据立方，误
差数据立方，协方差数据立方等数据。上述两个模块所需数据参见
1 级数据定义表。随后通过FITS 文件输出将头文件和图文件打包成
FITS 文件，生成一级多次合成数据，经过质量检验和索引之后保存
到数据库中。该工作包的结构示意图和功能模块列表分别见图
10.121 和表10.91。
叠加图像天体测
量信息
叠加图像流量及
可用性数据立方
叠加图像误差数
据立方
数据库
I FS多次
曝光合
成数据
D
R
P数据
头文件创建
图文件创建
FI TS文件输出
图10.121 IFS 多次曝光合成文件生成工作包的结构示意图
表10.91 IFS 多次曝光合成文件生成工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
头文件创建
天体测量信
息，其他有用
信息
头文件
创建头文件
2
图文件创建
流量，可用
性，误差等数
据立方
图文件
创建图文件
3
FITS 文件输出
头文件和图文
件
合成FITS
文件
输出包含头和图的标
准FITS 文件
4
质量检验、数据
合成FITS 文
合成FITS
质量检查，数据库关
161
库索引
件
文件
键字索引
8.3.3.20 IFS 一级合成数据质量检查工作包
该工作包作为二级数据处理流水线的第一个工作包单元（编号：
KSC-SJ6-PK-20），主要包含三个子模块：1）无效数据点检验，用
于确保使用的光谱数据点全部有效，无inf, nan 等数值；2）光谱流
量误差准确度检验，由于流量误差的确定依赖于很多环节及协方差
估计，给出的数值不一定确保完全准确，此部分将对光谱流量误差
做独立估计，和一级数据给出的误差做对比分析找出最佳合理值；3）
光谱信噪比检验，此子模块用于检验当前数据的信噪比分布是否能
满足科学需求。针对三个子模块的结果，若数据不符合要求，则根
据结果分析数据异常的可能性，反馈给一级数据处理环节，做数据
迭代。若满足要求，则执行下一步的数据空间像素合并模块。该工
作包的结构示意图和功能模块列表分别见图10.122 和表10.92。
图10.122 IFS 一级合成数据质量检查工作包的结构示意图
表10.92 IFS 一级合成数据质量检查工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
无效数据点检验
一级合成数据
立方
无效数据点
列表
检视数据立方中仅作
为填充的无效数据点
2
流量误差数据点
检验
一级合成数据
立方
误差异常标
记
检视数据立方中误差
异常点并标记
3
信噪比检验
一级合成数据
立方
信噪比异常
检验
检视数据立方中信噪
比异常点并标记
162
8.3.3.21 IFS 数据立方空间像素合并工作包
在IFS 的一级合成数据通过质量检验环节后，本工作包（编号：
KSC-SJ6-PK-21）根据科学需求对一级数据立方进行空间像素合并，
并将合并到一起的像素进行叠谱。叠谱完成之后，将对新的光谱进
行质量分析，确保后续的科学分析需求。该工作包的结构示意图和
功能模块列表分别见图10.123 和表10.93。
图10.123 IFS 合成数据空间像素合并工作包的结构示意图
表10.93 IFS 合成数据空间像素合并工作包的功能模块列表
序号
功能模块名称
输入
输出
实现功能
1
空间像素合并方
案
一级合成数据
立方，合并策
略
像素合并列
表
满足信噪比需求或者
给定方案的像素合并
2
光谱合并
一级合成数据
立方，合并方
案
进行光谱合
并后的数据
立方
按照合并方案进行光
谱合并和数据立方再
生成